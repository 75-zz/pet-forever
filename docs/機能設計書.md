# 犬のメモリアル動画カレンダー Webアプリ 機能設計書

## 1. アーキテクチャ概要
|層|役割|
|---|---|
UI | Tailwind / React コンポーネント
状態管理 | Zustand
ロジック | クラスベースサービス（OOP）
永続化 | IndexedDB (idb)
動作形式 | PWA + オフライン動作

---

## 2. OOP 設計
### コアクラス
|クラス|責務|
|---|---|
`CalendarService` | 日付計算 / 週番号算出
`WeeklyVideoScheduler` | 週次動画決定
`DiversityPicker` | 画像多様性ロジック
`ShuffleQueue<T>` | 重み付きシャッフル
`RoundConductor` | 再生シーケンス管理
`StorageRepo` | IndexedDB I/O
`SettingsManager` | 設定管理 / マイグレーション

---

## 3. データモデル

```ts
interface ImageItem {
  id: string;
  src: string;
  tags?: string[];
  takenAt?: string;
  weight?: number;
}

interface VideoItem {
  id: string;
  src: string;
  label?: string; // 第1週、第2週 etc
}

interface AppSettings {
  locale: 'ja' | 'en';
  weekStart: 'mon' | 'sun';
  calendarMode: 'day' | 'month';
  round: {
    videoSeconds: { min: number; max: number };
    imageSlots: number;
  };
  diversity: {
    historyWindow: number;
    tagSeparation: 'low' | 'medium' | 'high';
    rarityBoost: number;
  };
}
## 4. 画面設計

### 4.1 画面一覧
|画面名|概要|
|---|---|
Player画面 | メディア再生/カレンダー表示/設定アイコン
Settings画面 | 再生設定、UI設定、日付設定
Media Library画面 | 画像・動画アップロード、週ごとの割当、タグ管理
初回セットアップ | 使い方説明・サンプルメディア読み込み
PWA起動画面 | スプラッシュ表示

### 4.2 Player画面 UI
- メイン構成
  - メディア表示ステージ（動画 or 画像2枚）
  - カレンダーオーバーレイ
  - 右上に設定ボタン
- アクション
  - タップ／クリック → 設定を開く
  - Space → 再生/一時停止
  - F → 全画面

### 4.3 Settings画面 UI
- 設定項目
  - カレンダー
    - 日/週/月切替
    - 曜日表記
    - 週開始（Sun/Mon）
    - 年表示 ON/OFF
  - メディア
    - 動画1ラウンド長（秒）
    - 画像スロット数（2〜4）
    - ランダム角度/位置スイッチ
  - 言語切替
  - テーマ（白/黒/透明背景）
- 保存方法
  - `保存`ボタン もしくは `自動保存`

### 4.4 Media Library UI
- 機能
  - 画像/動画アップロード
  - 画像タグ編集
  - 第1〜第4週の動画割当（ドラッグ&ドロップ）
- 表示
  - グリッドサムネイル
  - 各メディアの表示回数メーター

## 5. 設定項目（ユーザー設定）

### 5.1 カレンダー設定
|項目|内容|
|---|---|
日表示 | 1日 / 1か月切替
曜日表記 | 日本語（例:（日）） / 英語（Sun）
年表示 | ON/OFF
週開始 | 日曜 or 月曜
日付フォーマット | `M/D`, `YYYY/M/D`, `M月D日` etc
記念日ハイライト | 色変更、アイコン（⭐/❤️）

### 5.2 メディア表示設定
|項目|内容|
|---|---|
動画1ラウンド時間 | 10〜20秒 or 固定
画像表示回数 | 2〜4スロット
画像ランダム度 | 角度/位置/拡大率
音声設定 | ON/OFF/ボリューム
背景 | 黒 / 任意色

### 5.3 多様性設定（画像）
|項目|内容|
|---|---|
履歴ウィンドウ | 最近20枚を除外
タグ分散 | 同タグ3連続禁止
希少度ブースト | 登場回数の少ない画像を優遇

---

## 6. メディア管理要件

### 6.1 ファイル取扱
|項目|詳細|
|---|---|
画像形式 | jpg / png / webp
動画形式 | mp4 / webm
ドラッグ&ドロップ | 対応
タグ付け | 任意タグ追加
週割当 | 第1〜4週に動画割当（DnD）

### 6.2 保存・読み込み
|機能|説明|
|---|---|
ローカル保存 | IndexedDB
設定エクスポート | JSON
設定インポート | JSON
初期化 | 全データ削除

---

## 7. 技術要件

### 7.1 技術スタック
|分類|採用技術|
|---|---|
フレームワーク | Next.js (React)
言語 | TypeScript
スタイル | Tailwind CSS
状態管理 | Zustand
日付処理 | date-fns / date-fns-tz
永続化 | IndexedDB + idb
PWA | Workbox

### 7.2 動作環境
- Chrome / Safari / Edge 最新
- iOS / Android 対応
- オフライン動作（PWA）

---

## 8. パフォーマンス要件

|項目|基準|
|---|---|
初回ロード | 2.5秒以内
アニメーション | 60fps目標
画像切替 | 1フレーム以内
動画推奨 | 1080p / 30fps

最適化手法:
- createImageBitmap で事前デコード
- requestAnimationFrame による描画制御
- lazy loading / prefetch / preconnect

---

## 9. アクセシビリティ要件

|要素|仕様|
|---|---|
テキスト判読性 | 白文字＋黒影必須
コントラスト | WCAG AA相当
キーボード操作 | Space＝再生/停止、F＝フルスクリーン
UI | タップ領域 44px以上（モバイル）

---

## 10. セキュリティ / プライバシー

- メディアはローカルのみ（クラウド非送信）
- IndexedDBアクセスはユー操作時のみ
- クリア機能（設定/メディア全削除）

---

## 11. 拡張機能（将来）

- Google Photos 連携
- BGM追加・音声フェード
- 顔検出による中心補正
- 記念日スライド自動挿入
- 「思い出アーカイブ」ビュー
- シェア用ショートクリップ生成

---
